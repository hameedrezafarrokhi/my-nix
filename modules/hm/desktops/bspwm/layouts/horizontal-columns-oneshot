#!/bin/bash
# SIMPLE three-column layout

DESKTOP=$(bspc query -D -d focused)

# Apply layout
windows=($(bspc query -N -n .window.!floating.!hidden -d focused))
[ ${#windows[@]} -eq 0 ] && exit 0

# Move all windows to root and make tiled
for w in "${windows[@]}"; do
    bspc node "$w" -t tiled
    bspc node "$w" -n @/ 2>/dev/null || true
done

# Balance to get clean state
bspc node @/ -B

# Now use bspc's rectangle command to create three columns
# Get monitor width
monitor=$(bspc query -M -m focused)
rect=$(bspc query -T -m $monitor | jq -r '.rectangle')
width=$(echo "$rect" | jq '.width')

# Calculate pixel positions
left_width=$((width * 15 / 100))
center_width=$((width * 70 / 100))
right_width=$((width - left_width - center_width))

# Use the -R flag to resize root's children
# We need to create three children first
# Split root twice
bspc node @/ -p east -o 0.15
right_container=$(bspc query -N -n '@/' | head -2 | tail -1)
bspc node "$right_container" -p west -o 0.8235

# Get the three containers
containers=($(bspc query -N -n '@/'))
if [ ${#containers[@]} -ge 3 ]; then
    left=${containers[0]}
    center=${containers[1]}
    right=${containers[2]}

    # Move master to center
    master=${windows[0]}
    bspc node "$master" -n "$center"

    # Move others to sides
    others=("${windows[@]:1}")
    for i in "${!others[@]}"; do
        if [ $((i % 2)) -eq 0 ]; then
            bspc node "${others[i]}" -n "$left"
        else
            bspc node "${others[i]}" -n "$right"
        fi
    done

    # Set vertical orientation for sides
    bspc node "$left" -o vertical
    bspc node "$right" -o vertical

    # Balance sides
    bspc node "$left" -B
    bspc node "$right" -B

    # Focus master
    bspc node "$center" -f

    echo "Three-column layout applied"
fi

bspc query -N -d | xargs -I id -n 1 bspc node id -p cancel

while bspc node -f east 2>/dev/null; do :; done && bspc node @/ -R 90
