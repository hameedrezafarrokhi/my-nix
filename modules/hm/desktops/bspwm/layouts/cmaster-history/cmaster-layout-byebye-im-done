#!/bin/bash
DESKTOP=$(bspc query -D -d focused)
LOCKFILE="$HOME/.cache/bspwm-cmaster-$DESKTOP.lock"

# Prevent multiple instances
if [[ -f "$LOCKFILE" ]] && kill -0 "$(cat "$LOCKFILE")" 2>/dev/null; then
    exit 0
fi

# Record current PID in lock file
echo $$ > "$LOCKFILE"

# Ensure lock file is removed when script exits
trap 'rm -f "$LOCKFILE"' EXIT


PID_FILE_LISTEN="$HOME/.cache/bspwm-cmaster-$DESKTOP.pid"

kill $(cat "$PID_FILE_LISTEN") 2>/dev/null
rm -f "$PID_FILE_LISTEN"

bsp-cmaster-oneshot

{
    while read -r line; do
        # Split the line into fields
        read -r event monitor desktop node action <<< "$line"

        # Only act if the desktop matches
        if [[ "$desktop" == "$DESKTOP" ]]; then
            case "$event" in
                node_add)
                    FOCUSED_WIN=$(bspc query -N -n focused)
                    window_count=$(bspc query -N -n .window.!floating.!hidden -d focused | wc -l)

                    if (( window_count == 1 )); then
                          if pgrep -x bsp-icon-bar >/dev/null; then
                              icon_bar_was_running=true
                              if (( window_count >= 1 )); then
                                  pkill -x bsp-icon-bar
                              fi
                          fi

                          if $icon_bar_was_running; then
                                bsp-icon-bar &
                          fi
                    fi

                    if (( window_count == 2 || window_count == 3 )); then
                          bsp-cmaster-layout
                    fi

                    if (( window_count % 2 == 1 && window_count >= 3 )); then

                          icon_bar_was_running=false
                          if pgrep -x bsp-icon-bar >/dev/null; then
                              icon_bar_was_running=true
                              if (( window_count >= 1 )); then
                                  pkill -x bsp-icon-bar
                              fi
                          fi
                          bspc node -f east
                          bspc node -f east
                          bspc node -f east
                          for ((i=0; i<window_count; i++)); do
                              bspc node -f north
                          done
                          bspc node --presel-dir \~north
                          bspc node -f "$FOCUSED_WIN"
                          bspc node -n last.!automatic
                          bsp-layout once even
                          bspc node -s west
                          jget() {
                              key=$1
                              shift
                              var=${*#*\"$key\":}
                              var=${var%%[,\}]*}
                              echo "$var"
                          }
                          master_size=55
                          mon_width=$(jget width "$(bspc query -T -m)")
                          want=$(( master_size * mon_width / 100 ))
                          have=$(jget width "$(bspc query -T -n focused)")
                          diff=$(( want - have ))
                          if (( diff > 0 )); then
                              if (( window_count % 2 == 1 )); then
                                  bspc node -z left  -$((diff / 2)) 0
                                  bspc node -z right $((diff / 2)) 0
                              else
                                  bias=$(( diff / window_count ))
                                  bspc node -z left  -$((diff / 2 + bias)) 0
                                  bspc node -z right $((diff / 2 - bias)) 0
                              fi
                          fi
                          if $icon_bar_was_running; then
                                bsp-icon-bar &
                          fi
                    fi


                    if (( window_count % 2 == 0 && window_count >= 4 )); then

                          icon_bar_was_running=false
                          if pgrep -x bsp-icon-bar >/dev/null; then
                              icon_bar_was_running=true
                              if (( window_count >= 1 )); then
                                  pkill -x bsp-icon-bar
                              fi
                          fi
                          bspc node -f west
                          bspc node -f west
                          bspc node -f west
                          for ((i=0; i<window_count; i++)); do
                              bspc node -f south
                          done
                          bspc node --presel-dir \~south
                          bspc node -f "$FOCUSED_WIN"
                          bspc node -n last.!automatic
                          bsp-layout once even
                          bspc node -s east
                          jget() {
                              key=$1
                              shift
                              var=${*#*\"$key\":}
                              var=${var%%[,\}]*}
                              echo "$var"
                          }
                          master_size=55
                          mon_width=$(jget width "$(bspc query -T -m)")
                          want=$(( master_size * mon_width / 100 ))
                          have=$(jget width "$(bspc query -T -n focused)")
                          diff=$(( want - have ))
                          if (( diff > 0 )); then
                              if (( window_count % 2 == 1 )); then
                                  bspc node -z left  -$((diff / 2)) 0
                                  bspc node -z right $((diff / 2)) 0
                              else
                                  bias=$(( diff / window_count ))
                                  bspc node -z left  -$((diff / 2 + bias)) 0
                                  bspc node -z right $((diff / 2 - bias)) 0
                              fi
                          fi
                          if $icon_bar_was_running; then
                                bsp-icon-bar &
                          fi

                    fi
                    ;;



                node_remove)
                    # Commands for node_remove
                    echo "Node removed from desktop $desktop"
                    bsp-cmaster-layout
                    ;;
                *)
                    # Ignore other events
                    ;;
            esac
        fi
    done < <(bspc subscribe node_add node_remove)
} &

# Save the PID of the background listener
echo $! > "$PID_FILE_LISTEN"
