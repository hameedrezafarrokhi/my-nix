#!/bin/bash

FOCUSED_WIN=$(bspc query -N -n focused)
TERM_TRACK_FILE="/tmp/center_master_spawned_terminal"
PID_FILE="$HOME/.cache/center_master_terminal_pid"
windowcount=$(bspc query -N -n .window.!floating.!hidden -d focused | wc -l)

case "$windowcount" in
    0) exit 0 ;;
esac

# 1 2 3 10+ windows, exit
case "$windowcount" in
    1|2|[1-9][0-9]*) exit 0 ;;  # 1,2,3, or 10+
esac

# 3 windows
if [ "$windowcount" -eq 3 ]; then

windows=($(bspc query -N -n .window.!floating.!hidden -d focused))
master=${windows[0]}
stack=("${windows[@]:1}")
cols=($(bspc query -N -n .leaf -d focused))
left=${cols[0]}
center=${cols[1]}
right=${cols[2]}
# 0 window , exit
[ ${#windows[@]} -eq 0 ] && exit

    bsp-layout once even
    for w in "${windows[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master" -p west
    bspc node "$master" -p east
    bspc node "$master" -n "$center"
    i=0
    for w in "${stack[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w" -n "$left"
        else
            bspc node "$w" -n "$right"
        fi
        ((i++))
    done
    bspc node "$left" -s south
    bspc node "$right" -s south
    bspc node "$center" -f
    bsp-layout once even
    bspc node -z left -150 0
    bspc node -z right 150 0
    #bsp-zoom
    [ -n "$FOCUSED_WIN" ] && bspc node "$FOCUSED_WIN" -f
    bspc node "$(bspc query -N -n focused)" -s "$(bspc query -N -n biggest.local)"
    exit
fi


# 5 windows
if [ "$windowcount" -eq 5 ]; then

windows=($(bspc query -N -n .window.!floating.!hidden -d focused))
master=${windows[0]}
stack=("${windows[@]:1}")
cols=($(bspc query -N -n .leaf -d focused))
left=${cols[0]}
center=${cols[1]}
right=${cols[2]}
# 0 window , exit
[ ${#windows[@]} -eq 0 ] && exit

    bsp-layout once even



    for w in "${windows[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master" -p west
    bspc node "$master" -p east
    bspc node "$master" -n "$center"
    i=0
    for w in "${stack[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w" -n "$left"
        else
            bspc node "$w" -n "$right"
        fi
        ((i++))
    done
    bspc node "$left" -s south
    bspc node "$right" -s south
    bspc node "$center" -f

    bspc node -z left -250 0
    bspc node -z right 250 0



    if [ -f "$PID_FILE" ]; then
      PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
        if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
          # try graceful termination first
          kill -TERM "$PID" 2>/dev/null  true
          bsp-zoom
          sleep 0.3
          # if still alive, force kill
          if kill -0 "$PID" 2>/dev/null; then
              kill -KILL "$PID" 2>/dev/null  true
          fi
        fi
      rm -f "$PID_FILE"
    fi



    bsp-layout once even
    bspc node -z left -150 0
    bspc node -z right 150 0
    #bsp-zoom
    [ -n "$FOCUSED_WIN" ] && bspc node "$FOCUSED_WIN" -f
    bspc node "$(bspc query -N -n focused)" -s "$(bspc query -N -n biggest.local)"
    exit

fi


# 4 windows
if [ "$windowcount" -eq 4 ]; then

"$TERMINAL" >/dev/null 2>&1 &
PID=$!
printf '%s\n' "$PID" > "$HOME/.cache/center_master_terminal_pid"


windows=($(bspc query -N -n .window.!floating.!hidden -d focused))
master=${windows[0]}
stack=("${windows[@]:1}")
cols=($(bspc query -N -n .leaf -d focused))
left=${cols[0]}
center=${cols[1]}
right=${cols[2]}
# 0 window , exit
[ ${#windows[@]} -eq 0 ] && exit

    bsp-layout once even

    for w in "${windows[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master" -p west
    bspc node "$master" -p east
    bspc node "$master" -n "$center"
    i=0
    for w in "${stack[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w" -n "$left"
        else
            bspc node "$w" -n "$right"
        fi
        ((i++))
    done
    bspc node "$left" -s south
    bspc node "$right" -s south
    bspc node "$center" -f


    if [ -f "$PID_FILE" ]; then
      PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
        if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
          # try graceful termination first
          kill -TERM "$PID" 2>/dev/null  true
         #bsp-zoom
          sleep 0.3
          # if still alive, force kill
          if kill -0 "$PID" 2>/dev/null; then
              kill -KILL "$PID" 2>/dev/null  true
          fi
        fi
      rm -f "$PID_FILE"
    fi


windows2=($(bspc query -N -n .window.!floating.!hidden -d focused))
master2=${windows2[0]}
stack2=("${windows2[@]:1}")
cols2=($(bspc query -N -n .leaf -d focused))
left2=${cols2[0]}
center2=${cols2[1]}
right2=${cols2[2]}
# 0 window , exit
[ ${#windows2[@]} -eq 0 ] && exit

    bsp-layout once even

    for w2 in "${windows2[@]}"; do
        bspc node "$w2" -t tiled
    done
    bspc node "$master2" -p west
    bspc node "$master2" -p east
    bspc node "$master2" -n "$center2"
    i=0
    for w2 in "${stack2[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w2" -n "$left2"
        else
            bspc node "$w2" -n "$right2"
        fi
        ((i++))
    done
    bspc node "$left2" -s south
    bspc node "$right2" -s south
    bspc node "$center2" -f

    [ -n "$FOCUSED_WIN" ] && bspc node "$FOCUSED_WIN" -f
    bspc node "$(bspc query -N -n focused)" -s "$(bspc query -N -n biggest.local)"

    bspc node -z left -100 0
    bspc node -z right 100 0

    exit

fi



# 6 windows
if [ "$windowcount" -eq 6 ]; then

"$TERMINAL" >/dev/null 2>&1 &
PID=$!
printf '%s\n' "$PID" > "$HOME/.cache/center_master_terminal_pid"


windows=($(bspc query -N -n .window.!floating.!hidden -d focused))
master=${windows[0]}
stack=("${windows[@]:1}")
cols=($(bspc query -N -n .leaf -d focused))
left=${cols[0]}
center=${cols[1]}
right=${cols[2]}
# 0 window , exit
[ ${#windows[@]} -eq 0 ] && exit

   #bsp-layout once even

    for w in "${windows[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master" -p west
    bspc node "$master" -p east
    bspc node "$master" -n "$center"
    i=0
    for w in "${stack[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w" -n "$left"
        else
            bspc node "$w" -n "$right"
        fi
        ((i++))
    done
    bspc node "$left" -s south
    bspc node "$right" -s south
    bspc node "$center" -f

   #bspc node -z left -250 0
   #bspc node -z right 250 0

    if [ -f "$PID_FILE" ]; then
      PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
        if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
          # try graceful termination first
          kill -TERM "$PID" 2>/dev/null  true
          bsp-zoom
          sleep 0.3
          # if still alive, force kill
          if kill -0 "$PID" 2>/dev/null; then
              kill -KILL "$PID" 2>/dev/null  true
          fi
        fi
      rm -f "$PID_FILE"
    fi


windows2=($(bspc query -N -n .window.!floating.!hidden -d focused))
master2=${windows2[0]}
stack2=("${windows2[@]:1}")
cols2=($(bspc query -N -n .leaf -d focused))
left2=${cols2[0]}
center2=${cols2[1]}
right2=${cols2[2]}
# 0 window , exit
[ ${#windows2[@]} -eq 0 ] && exit

    bsp-layout once even

    for w in "${windows2[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master2" -p west
    bspc node "$master2" -p east
    bspc node "$master2" -n "$center2"
    i=0
    for w2 in "${stack2[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w2" -n "$left2"
        else
            bspc node "$w2" -n "$right2"
        fi
        ((i++))
    done
    bspc node "$left2" -s south
    bspc node "$right2" -s south
    bspc node "$center2" -f

    bspc node -z left -250 0
    bspc node -z right 250 0

    [ -n "$FOCUSED_WIN" ] && bspc node "$FOCUSED_WIN" -f
    bspc node "$(bspc query -N -n focused)" -s "$(bspc query -N -n biggest.local)"

    bsp-layout once even
    bspc node -z left -300 0
    bspc node -z right 100 0

    exit
fi



# 7 windows
if [ "$windowcount" -eq 7 ]; then
windows=($(bspc query -N -n .window.!floating.!hidden -d focused))
master=${windows[0]}
stack=("${windows[@]:1}")
cols=($(bspc query -N -n .leaf -d focused))
left=${cols[0]}
center=${cols[1]}
right=${cols[2]}
# 0 window , exit
[ ${#windows[@]} -eq 0 ] && exit

   #bsp-layout once even

    for w in "${windows[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master" -p west
    bspc node "$master" -p east
    bspc node "$master" -n "$center"
    i=0
    for w in "${stack[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w" -n "$left"
        else
            bspc node "$w" -n "$right"
        fi
        ((i++))
    done
    bspc node "$left" -s south
    bspc node "$right" -s south
    bspc node "$center" -f

   #bspc node -z left -250 0
   #bspc node -z right 250 0

    if [ -f "$PID_FILE" ]; then
      PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
        if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
          # try graceful termination first
          kill -TERM "$PID" 2>/dev/null  true
          bsp-zoom
          sleep 0.3
          # if still alive, force kill
          if kill -0 "$PID" 2>/dev/null; then
              kill -KILL "$PID" 2>/dev/null  true
          fi
        fi
      rm -f "$PID_FILE"
    fi

   #[ -n "$FOCUSED_WIN" ] && bspc node "$FOCUSED_WIN" -f
   #bspc node "$(bspc query -N -n focused)" -s "$(bspc query -N -n biggest.local)"

   #bsp-layout once even
   #bspc node -z left -150 0
   #bspc node -z right 150 0

   #sleep 0.2

windows2=($(bspc query -N -n .window.!floating.!hidden -d focused))
master2=${windows2[0]}
stack2=("${windows2[@]:1}")
cols2=($(bspc query -N -n .leaf -d focused))
left2=${cols2[0]}
center2=${cols2[1]}
right2=${cols2[2]}
# 0 window , exit
[ ${#windows2[@]} -eq 0 ] && exit

    bsp-layout once even

    for w in "${windows2[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master2" -p west
    bspc node "$master2" -p east
    bspc node "$master2" -n "$center2"
    i=0
    for w2 in "${stack2[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w2" -n "$left2"
        else
            bspc node "$w2" -n "$right2"
        fi
        ((i++))
    done
    bspc node "$left2" -s south
    bspc node "$right2" -s south
    bspc node "$center2" -f

    bspc node -z left -250 0
    bspc node -z right 250 0

    [ -n "$FOCUSED_WIN" ] && bspc node "$FOCUSED_WIN" -f
    bspc node "$(bspc query -N -n focused)" -s "$(bspc query -N -n biggest.local)"

    bsp-layout once even
    bspc node -z left -150 0
    bspc node -z right 150 0

    exit
fi


# 8 windows

"$TERMINAL" >/dev/null 2>&1 &
PID=$!
printf '%s\n' "$PID" > "$HOME/.cache/center_master_terminal_pid"


if [ "$windowcount" -eq 8 ]; then

windows=($(bspc query -N -n .window.!floating.!hidden -d focused))
master=${windows[0]}
stack=("${windows[@]:1}")
cols=($(bspc query -N -n .leaf -d focused))
left=${cols[0]}
center=${cols[1]}
right=${cols[2]}
# 0 window , exit
[ ${#windows[@]} -eq 0 ] && exit

   #bsp-layout once even

    for w in "${windows[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master" -p west
    bspc node "$master" -p east
    bspc node "$master" -n "$center"
    i=0
    for w in "${stack[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w" -n "$left"
        else
            bspc node "$w" -n "$right"
        fi
        ((i++))
    done
    bspc node "$left" -s south
    bspc node "$right" -s south
    bspc node "$center" -f

   #bspc node -z left -250 0
   #bspc node -z right 250 0

    if [ -f "$PID_FILE" ]; then
      PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
        if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
          # try graceful termination first
          kill -TERM "$PID" 2>/dev/null  true
          bsp-zoom
          sleep 0.3
          # if still alive, force kill
          if kill -0 "$PID" 2>/dev/null; then
              kill -KILL "$PID" 2>/dev/null  true
          fi
        fi
      rm -f "$PID_FILE"
    fi

windows2=($(bspc query -N -n .window.!floating.!hidden -d focused))
master2=${windows2[0]}
stack2=("${windows2[@]:1}")
cols2=($(bspc query -N -n .leaf -d focused))
left2=${cols2[0]}
center2=${cols2[1]}
right2=${cols2[2]}
# 0 window , exit
[ ${#windows2[@]} -eq 0 ] && exit

    bsp-layout once even

    for w in "${windows2[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master2" -p west
    bspc node "$master2" -p east
    bspc node "$master2" -n "$center2"
    i=0
    for w2 in "${stack2[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w2" -n "$left2"
        else
            bspc node "$w2" -n "$right2"
        fi
        ((i++))
    done
    bspc node "$left2" -s south
    bspc node "$right2" -s south
    bspc node "$center2" -f

    [ -n "$FOCUSED_WIN" ] && bspc node "$FOCUSED_WIN" -f
    bspc node "$(bspc query -N -n focused)" -s "$(bspc query -N -n biggest.local)"


    bspc node -z left -200 0
    bspc node -z right 200 0
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -z right -30 0
    bspc node -s east
    bspc node -z right -20 0
    bspc node -z left -60 0
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s west
    bspc node -s south
    bspc node -s south
    bspc node @parent -R -90
    bspc node -s east
    bspc node @parent -R -90
    bspc node -s west
    bspc node -s west
    bspc node @parent -R -90
    bspc node -s east
    bsp-layout once even
    bspc node -z left -310 0
    bspc node -z right 180 0
   #bspc node -z left 20 0
   #bspc node @parent -R 90
   #bspc node -s west
   #bspc node -z left 20 0
   #bspc node -s west
   #bspc node @parent -R 90
   #bspc node -z left -250 0
   #bspc node -z right 250 0
   if [ -f "$PID_FILE" ]; then
    PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
      if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
        # try graceful termination first
        kill -TERM "$PID" 2>/dev/null  true
        bsp-zoom
        sleep 0.3
        # if still alive, force kill
        if kill -0 "$PID" 2>/dev/null; then
            kill -KILL "$PID" 2>/dev/null  true
            rm -f "$PID_FILE"
        fi
      fi
      rm -f "$PID_FILE"
    fi

    exit
fi



# 9 windows
if [ "$windowcount" -eq 9 ]; then

windows=($(bspc query -N -n .window.!floating.!hidden -d focused))
master=${windows[0]}
stack=("${windows[@]:1}")
cols=($(bspc query -N -n .leaf -d focused))
left=${cols[0]}
center=${cols[1]}
right=${cols[2]}
# 0 window , exit
[ ${#windows[@]} -eq 0 ] && exit

   #bsp-layout once even

    for w in "${windows[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master" -p west
    bspc node "$master" -p east
    bspc node "$master" -n "$center"
    i=0
    for w in "${stack[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w" -n "$left"
        else
            bspc node "$w" -n "$right"
        fi
        ((i++))
    done
    bspc node "$left" -s south
    bspc node "$right" -s south
    bspc node "$center" -f

   #bspc node -z left -250 0
   #bspc node -z right 250 0

    if [ -f "$PID_FILE" ]; then
      PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
        if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
          # try graceful termination first
          kill -TERM "$PID" 2>/dev/null  true
          bsp-zoom
          sleep 0.3
          # if still alive, force kill
          if kill -0 "$PID" 2>/dev/null; then
              kill -KILL "$PID" 2>/dev/null  true
          fi
        fi
      rm -f "$PID_FILE"
    fi

windows2=($(bspc query -N -n .window.!floating.!hidden -d focused))
master2=${windows2[0]}
stack2=("${windows2[@]:1}")
cols2=($(bspc query -N -n .leaf -d focused))
left2=${cols2[0]}
center2=${cols2[1]}
right2=${cols2[2]}
# 0 window , exit
[ ${#windows2[@]} -eq 0 ] && exit

    bsp-layout once even

    for w in "${windows2[@]}"; do
        bspc node "$w" -t tiled
    done
    bspc node "$master2" -p west
    bspc node "$master2" -p east
    bspc node "$master2" -n "$center2"
    i=0
    for w2 in "${stack2[@]}"; do
        if (( i % 2 == 0 )); then
            bspc node "$w2" -n "$left2"
        else
            bspc node "$w2" -n "$right2"
        fi
        ((i++))
    done
    bspc node "$left2" -s south
    bspc node "$right2" -s south
    bspc node "$center2" -f

    [ -n "$FOCUSED_WIN" ] && bspc node "$FOCUSED_WIN" -f
    bspc node "$(bspc query -N -n focused)" -s "$(bspc query -N -n biggest.local)"


    bspc node -z left -200 0
    bspc node -z right 200 0
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -z right -30 0
    bspc node -s east
    bspc node -z right -20 0
    bspc node -z left -60 0
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s west
    bspc node -s south
    bspc node -s south
    bspc node @parent -R -90
    bspc node -s east
    bspc node @parent -R -90
    bspc node -s west
    bspc node -s west
    bspc node @parent -R -90
    bspc node -s east
    bsp-layout once even
    bspc node -z left -250 0
    bspc node -z right 250 0
   #bspc node -z left 20 0
   #bspc node @parent -R 90
   #bspc node -s west
   #bspc node -z left 20 0
   #bspc node -s west
   #bspc node @parent -R 90
   #bspc node -z left -250 0
   #bspc node -z right 250 0
   if [ -f "$PID_FILE" ]; then
    PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
      if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
        # try graceful termination first
        kill -TERM "$PID" 2>/dev/null  true
        bsp-zoom
        sleep 0.3
        # if still alive, force kill
        if kill -0 "$PID" 2>/dev/null; then
            kill -KILL "$PID" 2>/dev/null  true
            rm -f "$PID_FILE"
        fi
      fi
      rm -f "$PID_FILE"
    fi

    exit
fi


echo "hello loser"
exit
