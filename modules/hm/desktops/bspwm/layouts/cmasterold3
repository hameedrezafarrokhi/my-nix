#!/bin/bash
# Center-master layout for already spawned windows in bspwm

# Note the Focused Window
FOCUSED_WIN=$(bspc query -N -n focused)

# Buffer Window
TERM_TRACK_FILE="/tmp/center_master_spawned_terminal"
PID_FILE="$HOME/.cache/center_master_terminal_pid"

# ONLY APPLY FOR 4-9 WINDOWS
windowcount=$(bspc query -N -n .window.!floating.!hidden -d focused | wc -l)
case "$windowcount" in
    1|2|[1-9][0-9]*) exit 0 ;;  # 1,2,3, or 10+
esac
case "$windowcount" in
    4|6|8)
          # launch terminal in background and save its PID
          "$TERMINAL" >/dev/null 2>&1 &
          PID=$!
          printf '%s\n' "$PID" > "$HOME/.cache/center_master_terminal_pid"
        ;;
esac
bsp-layout once even

# Get all windows on the current desktop
windows=($(bspc query -N -n .window -d focused))
[ ${#windows[@]} -eq 0 ] && exit

master=${windows[0]}
stack=("${windows[@]:1}")

# Tile all windows
for w in "${windows[@]}"; do
    bspc node "$w" -t tiled
done

# Step 1: Split master horizontally to create left/right containers
bspc node "$master" -p west   # left
bspc node "$master" -p east   # right

# Step 2: Identify columns
cols=($(bspc query -N -n .leaf -d focused))
left=${cols[0]}
center=${cols[1]}
right=${cols[2]}

# Step 3: Move master to center
bspc node "$master" -n "$center"

# Step 4: Move remaining windows into left/right alternately
i=0
for w in "${stack[@]}"; do
    if (( i % 2 == 0 )); then
        bspc node "$w" -n "$left"
    else
        bspc node "$w" -n "$right"
    fi
    ((i++))
done

# Step 5: Stack left/right vertically
bspc node "$left" -s south
bspc node "$right" -s south

# Step 6: Resize for approximate 20/60/20
#bspc node "$left" -z right 0.25
#bspc node "$right" -z left 0.25

# Step 7: Focus master
bspc node "$center" -f

bsp-layout once even

sleep 0.1

#bspc node $(bspc query -N -n last.local) -z right 200 0
#bspc node $(bspc query -N -d focused -n last.local) -z right 200 0
#bspc node $(bspc query -N -d focused -n last.local) -z right -40 0

#bspc query -N -n .window.!floating.!hidden -d focused | wc -l

if [ "$windowcount" -eq 3 ]; then
    bspc node -z left -150 0
    bspc node -z right 150 0
    bsp-zoom
fi
if [ "$windowcount" -eq 5 ] || [ "$windowcount" -eq 7 ]; then
    bspc node -z left -250 0
    bspc node -z right 250 0
   if [ -f "$PID_FILE" ]; then
    PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
      if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
        # try graceful termination first
        kill -TERM "$PID" 2>/dev/null  true
        bsp-zoom
        sleep 0.3
        # if still alive, force kill
        if kill -0 "$PID" 2>/dev/null; then
            kill -KILL "$PID" 2>/dev/null  true
        fi
      fi
      rm -f "$PID_FILE"
    fi
fi
if [ "$windowcount" -eq 9 ]; then
    bspc node -z left -200 0
    bspc node -z right 200 0
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -s west
    bspc node -z right -30 0
    bspc node -s east
    bspc node -z right -20 0
    bspc node -z left -60 0
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s east
    bspc node -s west
    bspc node -s south
    bspc node -s south
    bspc node @parent -R -90
    bspc node -s east
    bspc node @parent -R -90
    bspc node -s west
    bspc node -s west
    bspc node @parent -R -90
    bspc node -s east
    bsp-layout once even
    bspc node -z left -250 0
    bspc node -z right 250 0
   #bspc node -z left 20 0
   #bspc node @parent -R 90
   #bspc node -s west
   #bspc node -z left 20 0
   #bspc node -s west
   #bspc node @parent -R 90
   #bspc node -z left -250 0
   #bspc node -z right 250 0
   if [ -f "$PID_FILE" ]; then
    PID=$(sed -n '1p' "$PID_FILE" | tr -d '[:space:]')
      if [ -n "$PID" ] && printf '%s\n' "$PID" | grep -Eq '^[0-9]+$'; then
        # try graceful termination first
        kill -TERM "$PID" 2>/dev/null  true
        bsp-zoom
        sleep 0.3
        # if still alive, force kill
        if kill -0 "$PID" 2>/dev/null; then
            kill -KILL "$PID" 2>/dev/null  true
            rm -f "$PID_FILE"
        fi
      fi
      rm -f "$PID_FILE"
    fi
fi



[ -n "$FOCUSED_WIN" ] && bspc node "$FOCUSED_WIN" -f
bsp-zoom
